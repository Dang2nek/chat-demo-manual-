<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>V-Cipher v6 WebRTC Chat</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; padding: 20px; }
    h2 { color: #333; }
    #chat { border:1px solid #ccc; border-radius:5px; background:#fff; padding:10px; height:300px; overflow-y:auto; margin-bottom:10px; }
    .msg { margin:5px 0; }
    .me { color:blue; }
    .friend { color:green; }
    input, textarea { width:100%; padding:8px; margin:5px 0; border:1px solid #ccc; border-radius:5px; }
    button { padding:8px 15px; margin-top:5px; background:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer; }
    button:hover { background:#0056b3; }
  </style>
</head>
<body>
  <h2>üîê V-Cipher v6 WebRTC Chat</h2>
  <div id="chat"></div>
  <textarea id="msgInput" rows="3" placeholder="Type message..."></textarea>
  <button onclick="sendMsg()">Send</button>

  <script>
    const chatBox = document.getElementById("chat");
    const msgInput = document.getElementById("msgInput");

    // Connect to signaling server
    const signalingServer = new WebSocket("ws://localhost:3000");

    let pc = new RTCPeerConnection();
    let channel = pc.createDataChannel("chat");

    channel.onmessage = (e) => {
      addMsg("Friend", e.data, "friend");
    };

    pc.onicecandidate = ({candidate}) => {
      if (candidate) {
        signalingServer.send(JSON.stringify({type:"candidate", candidate}));
      }
    };

    pc.ondatachannel = (event) => {
      channel = event.channel;
      channel.onmessage = (e) => {
        addMsg("Friend", e.data, "friend");
      };
    };

    signalingServer.onmessage = async (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "offer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        signalingServer.send(JSON.stringify({type:"answer", answer}));
      } else if (data.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      } else if (data.type === "candidate" && data.candidate) {
        try {
          await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
        } catch (e) {
          console.error("Error adding candidate", e);
        }
      }
    };

    signalingServer.onopen = async () => {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      signalingServer.send(JSON.stringify({type:"offer", offer}));
    };

    function sendMsg() {
      const msg = msgInput.value;
      if (msg && channel && channel.readyState === "open") {
        channel.send(msg);
        addMsg("Me", msg, "me");
        msgInput.value = "";
      }
    }

    function addMsg(user, text, cls) {
      const div = document.createElement("div");
      div.className = "msg " + cls;
      div.textContent = user + ": " + text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>
