<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; connect-src 'self' ws: wss:; img-src 'self' data:; style-src 'self' 'unsafe-inline';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat E2E App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    #chat-container { max-width: 600px; margin: auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    #login-section, #chat-section { margin-bottom: 20px; }
    input, button { padding: 8px; margin: 4px 0; width: 100%; box-sizing: border-box; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 8px; background: #fafafa; }
    .message { margin: 5px 0; }
    .system { color: gray; font-style: italic; }
    #socket-id { font-size: 0.85em; color: #555; }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="login-section">
      <h3>Đăng nhập / Đăng ký</h3>
      <input type="text" id="username" placeholder="Tên đăng nhập">
      <input type="password" id="password" placeholder="Mật khẩu">
      <button id="register-btn">Đăng ký</button>
      <button id="login-btn">Đăng nhập</button>
      <div id="login-status"></div>
    </div>

    <div id="chat-section" style="display:none;">
      <div id="socket-id"></div>
      <div id="messages"></div>
      <input type="text" id="message-input" placeholder="Nhập tin nhắn...">
      <button id="send-btn">Gửi</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const loginSection = document.getElementById('login-section');
    const chatSection = document.getElementById('chat-section');
    const loginStatus = document.getElementById('login-status');
    const messages = document.getElementById('messages');
    const socketIdEl = document.getElementById('socket-id');

    // Đăng ký
    document.getElementById('register-btn').addEventListener('click', () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) return alert("Điền đủ thông tin");
      socket.emit('register', { username, password });
    });

    // Đăng nhập
    document.getElementById('login-btn').addEventListener('click', () => {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) return alert("Điền đủ thông tin");
      socket.emit('login', { username, password });
    });

    // Nhận kết quả đăng nhập/đăng ký
    socket.on('login-success', data => {
      loginSection.style.display = 'none';
      chatSection.style.display = 'block';
      socketIdEl.textContent = "Socket ID: " + data.socketId;
      messages.innerHTML += `<div class="system">Chào mừng ${data.username}!</div>`;
    });

    socket.on('login-failed', msg => {
      loginStatus.textContent = msg;
    });

    socket.on('register-success', msg => {
      loginStatus.textContent = msg;
    });

    socket.on('register-failed', msg => {
      loginStatus.textContent = msg;
    });

    // Nhận tin nhắn
    socket.on('chat-message', msg => {
      messages.innerHTML += `<div class="message"><strong>${msg.user}:</strong> ${msg.text}</div>`;
      messages.scrollTop = messages.scrollHeight;
    });

    // Gửi tin nhắn
    document.getElementById('send-btn').addEventListener('click', () => {
      const msg = document.getElementById('message-input').value;
      if (!msg.trim()) return;
      socket.emit('chat-message', msg);
      document.getElementById('message-input').value = '';
    });

    // Thông báo hệ thống
    socket.on('system-message', msg => {
      messages.innerHTML += `<div class="message system">${msg}</div>`;
      messages.scrollTop = messages.scrollHeight;
    });

    // Hiển thị socket id khi kết nối
    socket.on('connect', () => {
      socketIdEl.textContent = "Socket ID: " + socket.id;
    });
  </script>
</body>
</html>
