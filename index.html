<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat E2E Full</title>
<style>
body { font-family: Arial; background: #f2f2f2; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
#login-register, #chat { margin:auto; width:90%; max-width:500px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
#messages { border:1px solid #ccc; height:300px; overflow-y:auto; padding:10px; margin-bottom:10px; }
input, button { padding:10px; margin:5px 0; width:100%; box-sizing:border-box; }
</style>
</head>
<body>

<div id="login-register">
  <h2>Register / Login</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button id="registerBtn">Register</button>
  <button id="loginBtn">Login</button>
  <div id="status"></div>
</div>

<div id="chat" style="display:none;">
  <h2>Chat Room</h2>
  <div id="messages"></div>
  <input id="msgInput" placeholder="Type your message">
  <button id="sendBtn">Send</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let passphrase = null;
let username = null;

const loginDiv = document.getElementById('login-register');
const chatDiv = document.getElementById('chat');
const statusDiv = document.getElementById('status');
const messagesDiv = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');

document.getElementById('registerBtn').onclick = async () => {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  const res = await fetch('/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u, password:p}) });
  const data = await res.json();
  statusDiv.innerText = JSON.stringify(data);
};

document.getElementById('loginBtn').onclick = async () => {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  const res = await fetch('/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u, password:p}) });
  const data = await res.json();
  if(data.success){
    username = u;
    passphrase = data.passphrase;
    loginDiv.style.display = 'none';
    chatDiv.style.display = 'block';
    loadMessages();
  } else {
    statusDiv.innerText = data.error;
  }
};

document.getElementById('sendBtn').onclick = () => {
  const msg = msgInput.value;
  if(!msg) return;
  socket.emit('sendMessage', { username, message: msg, passphrase });
  msgInput.value = '';
};

socket.on('receiveMessage', (data) => {
  const div = document.createElement('div');
  div.innerText = `${data.username}: ${data.message}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

function loadMessages(){
  socket.emit('getMessages', passphrase);
}

socket.on('allMessages', (msgs) => {
  messagesDiv.innerHTML = '';
  msgs.forEach(m => {
    const div = document.createElement('div');
    div.innerText = `${m.username}: ${m.message}`;
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});
</script>
</body>
</html>
