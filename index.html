<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Messenger Clone</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { margin:0; font-family:Arial, sans-serif; }
    .login, .chat { display:none; height:100vh; }
    .login { display:flex; justify-content:center; align-items:center; flex-direction:column; }
    .chat { display:flex; }
    .sidebar { width:200px; background:#f0f0f0; padding:10px; border-right:1px solid #ccc; }
    .messages { flex:1; display:flex; flex-direction:column; }
    .msgs { flex:1; overflow-y:auto; padding:10px; background:#fff; }
    .input { display:flex; border-top:1px solid #ccc; }
    .input input { flex:1; padding:10px; border:none; outline:none; }
    .input button { padding:10px; }
    .msg.you { text-align:right; color:blue; }
    .msg.other { text-align:left; color:green; }
  </style>
</head>
<body>
  <!-- Login/Register -->
  <div class="login" id="loginPage">
    <h2>Đăng nhập / Đăng ký</h2>
    <input id="username" placeholder="Tên đăng nhập">
    <input id="password" type="password" placeholder="Mật khẩu">
    <button onclick="signup()">Đăng ký</button>
    <button onclick="login()">Đăng nhập</button>
    <div id="loginMsg"></div>
  </div>

  <!-- Chat -->
  <div class="chat" id="chatPage">
    <div class="sidebar">
      <h3>Bạn bè</h3>
      <div id="friends"></div>
      <input id="newFriend" placeholder="Thêm bạn...">
      <button onclick="addFriend()">Kết bạn</button>
    </div>
    <div class="messages">
      <div class="msgs" id="msgs"></div>
      <div class="input">
        <input id="msgInput" placeholder="Nhập tin nhắn...">
        <button onclick="sendMsg()">Gửi</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let currentUser = null;
    let currentChat = null;

    function signup() {
      socket.emit("signup", { username: username.value, password: password.value }, (res) => {
        loginMsg.textContent = res.message;
      });
    }

    function login() {
      socket.emit("login", { username: username.value, password: password.value }, (res) => {
        if (res.success) {
          currentUser = username.value;
          document.getElementById("loginPage").style.display="none";
          document.getElementById("chatPage").style.display="flex";
          loadFriends(res.friends);
        } else {
          loginMsg.textContent = res.message;
        }
      });
    }

    function loadFriends(friends) {
      const div = document.getElementById("friends");
      div.innerHTML = "";
      friends.forEach(f => {
        const btn = document.createElement("button");
        btn.textContent = f;
        btn.onclick = () => openChat(f);
        div.appendChild(btn);
      });
    }

    function addFriend() {
      const f = newFriend.value.trim();
      if (!f) return;
      socket.emit("add_friend", { friend: f }, (res) => {
        alert(res.message);
        if (res.success) loadFriends(res.friends);
      });
      newFriend.value = "";
    }

    function openChat(friend) {
      currentChat = friend;
      msgs.innerHTML = "";
      socket.emit("get_history", { withUser: friend }, (history) => {
        history.forEach(showMessage);
      });
    }

    function sendMsg() {
      if (!currentChat) return alert("Chọn bạn để chat");
      const text = msgInput.value.trim();
      if (!text) return;
      socket.emit("chat_message", { to: currentChat, message: text });
      msgInput.value = "";
    }

    socket.on("message", (msg) => {
      if (msg.from === currentUser && msg.to === currentChat || msg.to === currentUser && msg.from === currentChat) {
        showMessage(msg);
      }
    });

    function showMessage(msg) {
      const div = document.createElement("div");
      div.className = "msg " + (msg.from === currentUser ? "you" : "other");
      div.textContent = `${msg.from}: ${msg.message}`;
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
    }
  </script>
</body>
</html>
