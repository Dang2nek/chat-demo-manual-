<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Auto WebRTC Chat</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    textarea { width: 100%; height: 100px; margin-top: 10px; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>WebRTC Chat (Auto ICE)</h2>

  <button id="createOffer">Create Offer</button>
  <button id="createAnswer">Create Answer</button>

  <h3>Local Description</h3>
  <textarea id="localSDP" readonly></textarea>

  <h3>Remote Description</h3>
  <textarea id="remoteSDP"></textarea>
  <button id="setRemote">Set Remote</button>

  <h3>Chat</h3>
  <div id="chat"></div>
  <input type="text" id="msgBox" placeholder="Type message..." />
  <button id="sendBtn">Send</button>

  <script>
    let pc = new RTCPeerConnection();
    let channel;

    const localSDP = document.getElementById("localSDP");
    const remoteSDP = document.getElementById("remoteSDP");
    const chat = document.getElementById("chat");

    function log(msg) {
      chat.innerHTML += msg + "<br>";
      chat.scrollTop = chat.scrollHeight;
    }

    // Data channel cho peer A
    document.getElementById("createOffer").onclick = async () => {
      channel = pc.createDataChannel("chat");
      setupChannel(channel);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      // Ch·ªù ICE gather xong
      await waitIceGathering();
      localSDP.value = JSON.stringify(pc.localDescription);
    };

    // Peer B t·∫°o Answer
    document.getElementById("createAnswer").onclick = async () => {
      pc.ondatachannel = (e) => {
        channel = e.channel;
        setupChannel(channel);
      };

      const offer = JSON.parse(remoteSDP.value);
      await pc.setRemoteDescription(offer);

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      await waitIceGathering();
      localSDP.value = JSON.stringify(pc.localDescription);
    };

    // Set remote description
    document.getElementById("setRemote").onclick = async () => {
      const desc = JSON.parse(remoteSDP.value);
      await pc.setRemoteDescription(desc);
      log("‚úÖ Remote description set.");
    };

    // ICE gather auto
    function waitIceGathering() {
      return new Promise((resolve) => {
        if (pc.iceGatheringState === "complete") {
          resolve();
        } else {
          pc.onicegatheringstatechange = () => {
            if (pc.iceGatheringState === "complete") {
              resolve();
            }
          };
        }
      });
    }

    // Data channel setup
    function setupChannel(ch) {
      ch.onopen = () => log("üì° DataChannel opened");
      ch.onmessage = (e) => log("üë§ Peer: " + e.data);
    }

    // Send message
    document.getElementById("sendBtn").onclick = () => {
      const msg = document.getElementById("msgBox").value;
      if (channel && channel.readyState === "open") {
        channel.send(msg);
        log("You: " + msg);
        document.getElementById("msgBox").value = "";
      } else {
        log("‚ö†Ô∏è Channel not open");
      }
    };
  </script>
</body>
</html>
