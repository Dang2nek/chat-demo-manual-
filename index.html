<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat E2E</title>
<style>
  body { font-family: sans-serif; }
  #chat { height: 300px; overflow-y: scroll; border: 1px solid #ccc; margin-bottom: 10px; padding:5px; }
  #message { width: 70%; }
</style>
</head>
<body>
<h2>Chat Room</h2>
<label>Username:</label><input id="username"><br>
<label>Password:</label><input type="password" id="password"><br>
<button id="register">Register</button>
<button id="login">Login</button>
<p id="info"></p>

<div id="chat"></div>
<input id="message"><button id="send">Send</button>
<p>Socket ID: <span id="socketid"></span></p>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
let username = "";
let passphrase = "";

// Register
document.getElementById("register").onclick = async () => {
  const u = document.getElementById("username").value;
  const p = document.getElementById("password").value;
  const res = await fetch("/register", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({username:u,password:p})
  });
  document.getElementById("info").innerText = await res.text();
};

// Login
document.getElementById("login").onclick = async () => {
  const u = document.getElementById("username").value;
  const p = document.getElementById("password").value;
  const res = await fetch("/login", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({username:u,password:p})
  });
  const data = await res.json();
  username = data.username;
  passphrase = data.passphrase;
  document.getElementById("info").innerText = "Logged in as "+username;
  socket.emit("join",{username,passphrase});
  document.getElementById("socketid").innerText = socket.id;
};

// Send message
document.getElementById("send").onclick = () => {
  const msg = document.getElementById("message").value;
  socket.emit("chat message", msg);
  document.getElementById("message").value = "";
};

// Receive chat
socket.on("chat message", (msg) => {
  const chat = document.getElementById("chat");
  chat.innerHTML += "<b>"+msg.username+":</b> "+msg.text+"<br>";
  chat.scrollTop = chat.scrollHeight;
});

// Receive history
socket.on("chat history", (msgs)=>{
  const chat = document.getElementById("chat");
  chat.innerHTML = "";
  msgs.forEach(m=>{
    chat.innerHTML += "<b>"+m.username+":</b> "+m.text+"<br>";
  });
  chat.scrollTop = chat.scrollHeight;
});

// Block PrintScreen
document.addEventListener("keydown", e=>{
  if(e.key==="PrintScreen"){alert("Screenshot blocked"); e.preventDefault();}
});
</script>
</body>
</html>
