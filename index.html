<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Messenger Clone</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { margin: 0; font-family: "Segoe UI", Tahoma, sans-serif; height: 100vh; display: flex; }
    .sidebar { width: 220px; background: #f5f6f7; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
    .sidebar h2 { margin: 0; padding: 15px; font-size: 16px; border-bottom: 1px solid #ddd; background: #fff; }
    .contacts { flex: 1; overflow-y: auto; }
    .contact { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; }
    .contact:hover, .contact.active { background: #e7f3ff; }
    .chat { flex: 1; display: flex; flex-direction: column; background: #f0f2f5; }
    .chat-header { padding: 15px; background: #fff; border-bottom: 1px solid #ddd; font-weight: bold; }
    .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
    .msg { margin: 6px 0; max-width: 70%; padding: 10px 14px; border-radius: 18px; line-height: 1.4; font-size: 14px; }
    .msg.you { align-self: flex-end; background: #0084ff; color: white; border-bottom-right-radius: 4px; }
    .msg.other { align-self: flex-start; background: white; color: black; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
    .input-area { display: flex; padding: 10px; background: white; border-top: 1px solid #ddd; }
    .input-area input { flex: 1; padding: 10px 12px; border-radius: 20px; border: 1px solid #ccc; outline: none; font-size: 14px; }
    .input-area button { margin-left: 10px; padding: 10px 16px; border: none; border-radius: 20px; background: #0084ff; color: white; font-size: 14px; cursor: pointer; }
    .input-area button:hover { background: #006fe0; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Liên hệ</h2>
    <div class="contacts" id="contacts">
      <div class="contact active" data-user="Alice">Alice</div>
      <div class="contact" data-user="Bob">Bob</div>
      <div class="contact" data-user="Charlie">Charlie</div>
    </div>
  </div>

  <div class="chat">
    <div class="chat-header" id="chatHeader">Alice</div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input id="msg" placeholder="Nhập tin nhắn...">
      <button onclick="sendMsg()">Gửi</button>
    </div>
  </div>

  <script>
    const socket = io();

    let username = localStorage.getItem("chat_username") || prompt("Nhập tên của bạn:");
    localStorage.setItem("chat_username", username);
    socket.emit("register", username);

    let currentChat = "Alice"; // mặc định chat Alice
    const messagesDiv = document.getElementById("messages");
    const chatHeader = document.getElementById("chatHeader");

    function addMessage(data, type) {
      const div = document.createElement("div");
      div.className = "msg " + type;
      div.textContent = data.message;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function loadChat(user) {
      messagesDiv.innerHTML = "";
      chatHeader.textContent = user;
      currentChat = user;
      socket.emit("join_chat", { from: username, to: user });
    }

    function sendMsg() {
      const input = document.getElementById("msg");
      const msg = input.value.trim();
      if (!msg) return;

      const msgObj = { from: username, to: currentChat, message: msg };
      socket.emit("chat_message", msgObj);
      addMessage(msgObj, "you");
      input.value = "";
    }

    socket.on("chat_history", (history) => {
      messagesDiv.innerHTML = "";
      history.forEach(msg => {
        addMessage(msg, msg.from === username ? "you" : "other");
      });
    });

    socket.on("message", (data) => {
      if ((data.from === currentChat && data.to === username) ||
          (data.to === currentChat && data.from === username)) {
        addMessage(data, data.from === username ? "you" : "other");
      }
    });

    // Chuyển liên hệ
    document.getElementById("contacts").addEventListener("click", (e) => {
      if (e.target.classList.contains("contact")) {
        document.querySelectorAll(".contact").forEach(c => c.classList.remove("active"));
        e.target.classList.add("active");
        loadChat(e.target.dataset.user);
      }
    });

    // Load mặc định
    loadChat(currentChat);
  </script>
</body>
</html>
