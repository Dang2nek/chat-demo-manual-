<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; display:flex; height:100vh; }
    .sidebar { width: 220px; background:#f1f1f1; border-right:1px solid #ddd; padding:10px; }
    .chatbox { flex:1; display:flex; flex-direction:column; }
    .messages { flex:1; padding:10px; overflow-y:auto; background:#fafafa; }
    .msg { margin:5px 0; }
    .msg.you { text-align:right; color:blue; }
    .msg.other { text-align:left; color:green; }
    .input-area { display:flex; border-top:1px solid #ddd; }
    .input-area input { flex:1; padding:10px; border:none; outline:none; }
    .input-area button { padding:10px; border:none; background:#0078ff; color:#fff; cursor:pointer; }
    .login, .register { margin:20px; }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>Người dùng</h3>
    <ul id="users"></ul>
    <hr>
    <div class="register">
      <h4>Đăng ký</h4>
      <input id="regUser" placeholder="Tên"><br>
      <input id="regPass" type="password" placeholder="Mật khẩu"><br>
      <button onclick="register()">Đăng ký</button>
      <p id="regMsg"></p>
    </div>
    <div class="login">
      <h4>Đăng nhập</h4>
      <input id="loginUser" placeholder="Tên"><br>
      <input id="loginPass" type="password" placeholder="Mật khẩu"><br>
      <button onclick="login()">Đăng nhập</button>
      <p id="loginMsg"></p>
    </div>
  </div>

  <div class="chatbox">
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input id="msgInput" placeholder="Nhập tin nhắn..." disabled>
      <button onclick="sendMsg()" disabled id="sendBtn">Gửi</button>
    </div>
  </div>

  <script>
    const socket = io("http://localhost:3000");
    let currentUser = null;
    let chattingWith = null;

    function register() {
      const username = document.getElementById("regUser").value;
      const password = document.getElementById("regPass").value;
      socket.emit("register", { username, password });
    }

    socket.on("register_response", (res) => {
      document.getElementById("regMsg").textContent = res.message;
    });

    function login() {
      const username = document.getElementById("loginUser").value;
      const password = document.getElementById("loginPass").value;
      socket.emit("login", { username, password });
    }

    socket.on("login_response", (res) => {
      document.getElementById("loginMsg").textContent = res.message;
      if (res.success) {
        currentUser = res.username;
        document.getElementById("msgInput").disabled = false;
        document.getElementById("sendBtn").disabled = false;
      }
    });

    socket.on("online_users", (list) => {
      const ul = document.getElementById("users");
      ul.innerHTML = "";
      list.forEach(u => {
        if (u === currentUser) return;
        const li = document.createElement("li");
        li.textContent = u;
        li.style.cursor = "pointer";
        li.onclick = () => { chattingWith = u; alert("Đang chat với " + u); };
        ul.appendChild(li);
      });
    });

    socket.on("load_messages", (msgs) => {
      msgs.forEach(m => showMsg(m));
    });

    socket.on("chatMessage", (msg) => {
      showMsg(msg);
    });

    function sendMsg() {
      const text = document.getElementById("msgInput").value;
      if (!text || !chattingWith) return alert("Chọn người để chat!");
      socket.emit("chatMessage", { to: chattingWith, message: text });
      document.getElementById("msgInput").value = "";
    }

    function showMsg(m) {
      const div = document.createElement("div");
      if (m.from === currentUser) {
        div.className = "msg you";
        div.textContent = "Bạn: " + m.message;
      } else {
        div.className = "msg other";
        div.textContent = m.from + ": " + m.message;
      }
      document.getElementById("messages").appendChild(div);
    }
  </script>
</body>
</html>
